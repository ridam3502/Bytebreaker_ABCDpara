<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABCD Parameter Transmission Line Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-white { background-color: #2d3748; }
        .dark .text-gray-800 { color: #e2e8f0; }
        .dark .text-gray-700 { color: #a0aec0; }
        .dark .text-gray-600 { color: #718096; }
        .dark .text-gray-500 { color: #a0aec0; }
        .dark .border-gray-300 { border-color: #4a5568; }
        .dark .border-gray-200 { border-color: #4a5568; }
        .dark .bg-gray-50 { background-color: #2d3748; }
        .dark .bg-gray-100 { background-color: #1a202c; }
        .dark .bg-gray-200 { background-color: #4a5568; }
        .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); }
        .dark input[type="number"], .dark select, .dark textarea {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #718096;
        }
        .dark .tab-button {
            color: #a0aec0;
        }
        .dark .tab-button.active {
            color: #3b82f6; /* Or a lighter blue for dark mode */
            border-color: #3b82f6;
        }
        .dark .guidance-panel {
            background-color: #2c3748; /* Slightly lighter than main dark bg */
            border-left-color: #60a5fa; /* Lighter blue for accent */
        }
        .dark .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .dark .modal-close-button { color: #cbd5e0; }
        .dark .modal-close-button:hover { color: #ffffff; }

        .tab-button.active {
            border-bottom-width: 2px;
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .step-content.hidden { display: none; }
        .loader {
            border: 5px solid #f3f3f3; /* Light grey */
            border-top: 5px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .user-calc-feedback.correct { color: #22c55e; } /* Green */
        .user-calc-feedback.incorrect { color: #ef4444; } /* Red */

        /* Ensure LaTeX is visible in dark mode */
        .dark mjx-container { color: #e2e8f0 !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="loader"></div>
        <p class="text-white text-xl ml-4">Calculating...</p>
    </div>

    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md text-center">
            <p id="alert-message" class="text-lg mb-4"></p>
            <button id="alert-ok-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg">OK</button>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md text-center">
            <p id="confirm-message" class="text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg">Yes</button>
                <button id="confirm-no-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-lg">No</button>
            </div>
        </div>
    </div>
    
    <div id="theory-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4 overflow-y-auto">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-blue-600">Theoretical Background</h2>
                <button id="theory-modal-close-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="theory-modal-content" class="text-sm md:text-base">
                </div>
        </div>
    </div>


    <div class="container mx-auto p-4">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-blue-700">ABCD Parameter Transmission Line Simulator</h1>
            <div class="flex items-center space-x-4">
                <button id="print-btn" title="Print Current View" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a8.518 8.518 0 0 1 3.586 0M6.72 13.829V3.75A2.25 2.25 0 0 1 9 1.5h6A2.25 2.25 0 0 1 17.25 3.75v10.079M6.72 13.829A2.25 2.25 0 0 0 9 16.125h6a2.25 2.25 0 0 0 2.25-2.296V3.75m-10.5 10.079h10.5" />
                    </svg>
                </button>
                <button id="screenshot-btn" title="Take Screenshot" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.174C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.174 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                    </svg>
                </button>
                <button id="voice-toggle-btn" title="Toggle Voice Instructions" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg id="voice-on-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
                    </svg>
                    <svg id="voice-off-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6.375a5.625 5.625 0 1 1-11.25 0 5.625 5.625 0 0 1 11.25 0ZM12.75 9.75 10.5 12m0 0 2.25 2.25M10.5 12l2.25-2.25M10.5 12l-2.25 2.25M7.5 15l2.25-2.25M7.5 15l-2.25-2.25M7.5 15l2.25 2.25M7.5 15l-2.25 2.25M15 9.75l2.25-2.25M15 9.75l-2.25-2.25M15 9.75l2.25 2.25M15 9.75l-2.25 2.25" />
                    </svg>
                </button>
                <label for="dark-mode-toggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                        <div class="block bg-gray-600 w-10 h-6 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                    </div>
                    <div class="ml-3 text-gray-700 dark:text-gray-300 text-sm font-medium">Dark Mode</div>
                </label>
            </div>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="border-b border-gray-300 mb-6">
                <nav class="flex space-x-1 sm:space-x-4" aria-label="Tabs">
                    <button data-tab="simulationTab" class="tab-button py-3 px-2 sm:px-4 text-sm sm:text-base text-gray-600 hover:text-blue-600 focus:outline-none active">Simulation</button>
                    <button data-tab="historyTab" class="tab-button py-3 px-2 sm:px-4 text-sm sm:text-base text-gray-600 hover:text-blue-600 focus:outline-none">History</button>
                    <button data-tab="analyticsTab" class="tab-button py-3 px-2 sm:px-4 text-sm sm:text-base text-gray-600 hover:text-blue-600 focus:outline-none">Analytics</button>
                    <button data-tab="comparisonTab" class="tab-button py-3 px-2 sm:px-4 text-sm sm:text-base text-gray-600 hover:text-blue-600 focus:outline-none">Comparison</button>
                </nav>
            </div>

            <div id="simulationTab" class="tab-panel active">
                <div class="guidance-panel bg-blue-50 border-l-4 border-blue-500 p-4 rounded-md mb-6">
                    <h3 id="step-title" class="text-xl font-semibold text-blue-700 mb-1"></h3>
                    <p id="step-instruction" class="text-gray-700"></p>
                </div>

                <div id="step1Content" class="step-content">
                    <p class="mb-4 text-lg">Welcome to the ABCD Parameter Transmission Line Simulator! This tool helps you understand how different parameters affect transmission line performance.</p>
                    <p class="mb-6">ABCD parameters (also known as transmission parameters) relate the sending end voltage ($V_S$) and current ($I_S$) to the receiving end voltage ($V_R$) and current ($I_R$) of a two-port network, like a transmission line:
                    $$ V_S = A V_R + B I_R $$
                    $$ I_S = C V_R + D I_R $$
                    These parameters are crucial for analyzing voltage regulation, efficiency, and stability of power systems.
                    </p>
                    <button id="start-sim-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Start Simulation</button>
                </div>

                <div id="step2Content" class="step-content hidden">
                    <h4 class="text-xl font-semibold mb-4 text-gray-700">Transmission Line Parameters:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="lineLength" class="block text-sm font-medium text-gray-700">Line Length (km):</label>
                            <input type="number" id="lineLength" value="100" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="resistance" class="block text-sm font-medium text-gray-700">Resistance (R/km, Ω):</label>
                            <input type="number" id="resistance" value="0.1" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="inductance" class="block text-sm font-medium text-gray-700">Inductance (L/km, mH):</label>
                            <input type="number" id="inductance" value="1.0" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="capacitance" class="block text-sm font-medium text-gray-700">Capacitance (C/km, nF):</label>
                            <input type="number" id="capacitance" value="10" step="0.1" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="frequency" class="block text-sm font-medium text-gray-700">Frequency (Hz):</label>
                            <input type="number" id="frequency" value="50" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                     <h4 class="text-xl font-semibold mb-4 text-gray-700">Transmission Line Model:</h4>
                    <div class="mb-6">
                        <select id="lineModel" class="block w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="short">Short Transmission Line</option>
                            <option value="mediumT">Medium Line (Nominal T)</option>
                            <option value="mediumPi" selected>Medium Line (Nominal π)</option>
                            <option value="long">Long Transmission Line</option>
                        </select>
                    </div>
                    <div class="flex space-x-4">
                        <button id="params-to-review-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Confirm Parameters</button>
                        <button id="load-defaults-params-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Load Defaults</button>
                    </div>
                </div>

                <div id="step3Content" class="step-content hidden">
                    <h4 class="text-xl font-semibold mb-4 text-gray-700">Review Entered Data:</h4>
                    <div id="review-data-display" class="space-y-2 p-4 border border-gray-200 rounded-md bg-gray-50 mb-6">
                        </div>
                    <div class="flex space-x-4">
                        <button id="review-to-theory-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Proceed to Theory</button>
                        <button id="review-to-params-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Back to Parameters</button>
                    </div>
                </div>

                <div id="step4Content" class="step-content hidden">
                    <h4 class="text-xl font-semibold mb-4 text-gray-700">Theoretical Background:</h4>
                    <div id="theory-display" class="prose dark:prose-invert max-w-none p-4 border border-gray-200 rounded-md bg-gray-50 mb-6">
                        </div>
                    <button id="show-full-theory-modal-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg mb-6">View Detailed Formulas</button>
                    <div class="flex space-x-4">
                        <button id="theory-to-load-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Set Load Conditions</button>
                        <button id="theory-to-review-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Back to Review</button>
                    </div>
                </div>

                <div id="step5Content" class="step-content hidden">
                    <h4 class="text-xl font-semibold mb-4 text-gray-700">Load Conditions & Operating Point:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="vrMag" class="block text-sm font-medium text-gray-700">Receiving End Voltage ($V_R$) Magnitude (kV, Line-to-Line):</label>
                            <input type="number" id="vrMag" value="220" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="vrPhase" class="block text-sm font-medium text-gray-700">$V_R$ Phase Angle (degrees):</label>
                            <input type="number" id="vrPhase" value="0" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="loadType" class="block text-sm font-medium text-gray-700">Load Specification Type:</label>
                            <select id="loadType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="power" selected>Power & Power Factor</option>
                                <option value="impedance">Impedance</option>
                            </select>
                        </div>
                    </div>
                    <div id="loadPowerInputs" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="loadPower" class="block text-sm font-medium text-gray-700">Load Active Power (MW, 3-phase):</label>
                            <input type="number" id="loadPower" value="50" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="loadPF" class="block text-sm font-medium text-gray-700">Load Power Factor:</label>
                            <input type="number" id="loadPF" value="0.8" step="0.01" min="0" max="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="loadPFType" class="block text-sm font-medium text-gray-700">Power Factor Type:</label>
                            <select id="loadPFType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="lagging" selected>Lagging</option>
                                <option value="leading">Leading</option>
                            </select>
                        </div>
                    </div>
                    <div id="loadImpedanceInputs" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 hidden">
                        <div>
                            <label for="loadZMag" class="block text-sm font-medium text-gray-700">Load Impedance ($Z_L$) Magnitude (Ω, per phase):</label>
                            <input type="number" id="loadZMag" value="100" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="loadZAngle" class="block text-sm font-medium text-gray-700">$Z_L$ Phase Angle (degrees):</label>
                            <input type="number" id="loadZAngle" value="36.87" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button id="load-to-usercalc-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Proceed to Self-Calculation</button>
                        <button id="load-to-theory-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Back to Theory</button>
                    </div>
                </div>

                <div id="step6Content" class="step-content hidden">
                    <h4 class="text-xl font-semibold mb-4 text-gray-700">Your Turn: Estimate Results!</h4>
                    <p class="mb-4 text-gray-600">Based on the parameters and theory, try to estimate the following values. This will help reinforce your understanding.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="userA" class="block text-sm font-medium text-gray-700">Est. Magnitude of A:</label>
                            <input type="number" id="userA" step="0.001" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p id="feedbackA" class="user-calc-feedback text-sm mt-1"></p>
                        </div>
                        <div>
                            <label for="userB" class="block text-sm font-medium text-gray-700">Est. Magnitude of B (Ω):</label>
                            <input type="number" id="userB" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p id="feedbackB" class="user-calc-feedback text-sm mt-1"></p>
                        </div>
                        <div>
                            <label for="userC" class="block text-sm font-medium text-gray-700">Est. Magnitude of C (mS):</label>
                            <input type="number" id="userC" step="0.001" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p id="feedbackC" class="user-calc-feedback text-sm mt-1"></p>
                        </div>
                        <div>
                            <label for="userD" class="block text-sm font-medium text-gray-700">Est. Magnitude of D:</label>
                            <input type="number" id="userD" step="0.001" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p id="feedbackD" class="user-calc-feedback text-sm mt-1"></p>
                        </div>
                        <div>
                            <label for="userVsMag" class="block text-sm font-medium text-gray-700">Est. $V_S$ Magnitude (kV, L-L):</label>
                            <input type="number" id="userVsMag" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p id="feedbackVsMag" class="user-calc-feedback text-sm mt-1"></p>
                        </div>
                        <div>
                            <label for="userVR" class="block text-sm font-medium text-gray-700">Est. Voltage Regulation (%):</label>
                            <input type="number" id="userVR" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p id="feedbackVR" class="user-calc-feedback text-sm mt-1"></p>
                        </div>
                        <div>
                            <label for="userEff" class="block text-sm font-medium text-gray-700">Est. Efficiency (%):</label>
                            <input type="number" id="userEff" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p id="feedbackEff" class="user-calc-feedback text-sm mt-1"></p>
                        </div>
                    </div>
                    <div class="flex space-x-4 mt-4">
                        <button id="check-user-calc-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg">Check My Estimates</button>
                        <button id="usercalc-to-results-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">View Simulation Results</button>
                        <button id="usercalc-to-load-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Back to Load</button>
                    </div>
                </div>

                <div id="step7Content" class="step-content hidden">
                    <h4 class="text-2xl font-bold mb-6 text-gray-800">Simulation Results:</h4>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h5 class="text-lg font-semibold mb-3 text-blue-700">Calculated Line Constants:</h5>
                            <p><strong>Total Series Impedance (Z):</strong> <span id="resultZ"></span> Ω</p>
                            <p><strong>Total Shunt Admittance (Y):</strong> <span id="resultY"></span> S</p>
                            <div id="longLineConstants" class="hidden mt-2">
                                <p><strong>Characteristic Impedance ($Z_C$):</strong> <span id="resultZc"></span> Ω</p>
                                <p><strong>Propagation Constant ($\gamma l$):</strong> <span id="resultGammaL"></span></p>
                            </div>
                        </div>

                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h5 class="text-lg font-semibold mb-3 text-blue-700">ABCD Parameters:</h5>
                            <p><strong>A:</strong> <span id="resultA"></span></p>
                            <p><strong>B:</strong> <span id="resultB"></span> Ω</p>
                            <p><strong>C:</strong> <span id="resultC"></span> S</p>
                            <p><strong>D:</strong> <span id="resultD"></span></p>
                        </div>

                        <div class="lg:col-span-2 p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h5 class="text-lg font-semibold mb-3 text-blue-700">Performance Metrics:</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                                <p><strong>Sending End Voltage ($V_S$):</strong> <span id="resultVs"></span> kV ∠ <span id="resultVsAngle"></span>° (L-L)</p>
                                <p><strong>Sending End Current ($I_S$):</strong> <span id="resultIs"></span> A ∠ <span id="resultIsAngle"></span>°</p>
                                <p><strong>Receiving End Current ($I_R$):</strong> <span id="resultIr"></span> A ∠ <span id="resultIrAngle"></span>°</p>
                                <p><strong>Sending End Active Power ($P_S$):</strong> <span id="resultPs"></span> MW (3-ph)</p>
                                <p><strong>Receiving End Active Power ($P_R$):</strong> <span id="resultPr"></span> MW (3-ph)</p>
                                <p><strong>Sending End Reactive Power ($Q_S$):</strong> <span id="resultQs"></span> MVAr (3-ph)</p>
                                <p><strong>Receiving End Reactive Power ($Q_R$):</strong> <span id="resultQr"></span> MVAr (3-ph)</p>
                                <p class="font-bold text-green-600"><strong>Voltage Regulation (VR):</strong> <span id="resultVR"></span> %</p>
                                <p class="font-bold text-green-600"><strong>Efficiency ($\eta$):</strong> <span id="resultEff"></span> %</p>
                            </div>
                        </div>
                        
                        <div class="lg:col-span-2 p-4 border border-gray-200 rounded-lg bg-gray-50">
                             <h5 class="text-lg font-semibold mb-3 text-blue-700">Phasor Diagram ($V_R$ as reference):</h5>
                             <div id="phasorDiagram" class="w-full h-80 md:h-96 bg-gray-200 rounded-md flex items-center justify-center text-gray-500">
                                 Phasor Diagram will appear here.
                             </div>
                        </div>
                    </div>
                    <div class="flex space-x-4 mt-6">
                        <button id="results-to-analysis-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Analyze & Experiment Further</button>
                        <button id="save-results-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Save Experiment</button>
                        <button id="results-to-usercalc-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Back to Self-Calc</button>
                    </div>
                </div>

                <div id="step8Content" class="step-content hidden">
                    <h4 class="text-xl font-semibold mb-4 text-gray-700">Analysis & Further Experimentation:</h4>
                    <p class="mb-4 text-gray-600">You've completed a simulation run! Consider the following:</p>
                    <ul class="list-disc list-inside mb-6 text-gray-600 space-y-1">
                        <li>How did the chosen line model affect the ABCD parameters and performance?</li>
                        <li>What is the impact of line length on voltage regulation and efficiency?</li>
                        <li>How does the load power factor influence the sending end conditions?</li>
                        <li>Experiment with different parameters to observe their effects. Use the "Run New Experiment" button to go back to the parameter input step.</li>
                        <li>Check the 'Experiment History' and 'Analytics Dashboard' tabs to review past runs and identify trends.</li>
                    </ul>
                    <div class="flex flex-wrap gap-4">
                        <button id="analysis-to-params-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Run New Experiment</button>
                        <button onclick="document.querySelector('[data-tab=\'historyTab\']').click()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg">View Experiment History</button>
                        <button onclick="document.querySelector('[data-tab=\'analyticsTab\']').click()" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg">Open Analytics Dashboard</button>
                    </div>
                </div>
                
                <div class="mt-8 pt-6 border-t border-gray-200 flex justify-center">
                    <button id="reset-simulation-flow-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Reset Entire Simulation Flow</button>
                </div>

            </div>

            <div id="historyTab" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Experiment History</h2>
                <div class="mb-4 flex flex-col sm:flex-row gap-2">
                    <input type="text" id="historyNoteInput" placeholder="Add a note for the current experiment before saving..." class="flex-grow p-2 border border-gray-300 rounded-md">
                    <button id="saveCurrentConfigWithNoteBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md whitespace-nowrap">Save Current with Note</button>
                </div>
                <div class="mb-4 flex flex-wrap gap-2">
                    <button id="exportCsvBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">Export to CSV</button>
                    <button id="clearHistoryBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md">Clear All History</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="historyTable" class="min-w-full bg-white border border-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Length (km)</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Load (MW, PF)</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">|A|</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">|B| (Ω)</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VR (%)</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Eff (%)</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Compare</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                 <p id="no-history-msg" class="text-gray-500 mt-4 hidden">No experiments saved yet.</p>
            </div>

            <div id="analyticsTab" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Analytics Dashboard</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-2 text-blue-700">Voltage Regulation vs. Line Length</h3>
                        <div id="vrVsLengthChart" class="w-full h-72 bg-gray-200 rounded-md flex items-center justify-center text-gray-500">Chart Area</div>
                    </div>
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-2 text-blue-700">Efficiency vs. Load Power Factor</h3>
                        <div id="effVsPfChart" class="w-full h-72 bg-gray-200 rounded-md flex items-center justify-center text-gray-500">Chart Area</div>
                    </div>
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-2 text-blue-700">Impact of Line Model on $V_S$</h3>
                        <div id="modelImpactChart" class="w-full h-72 bg-gray-200 rounded-md flex items-center justify-center text-gray-500">Chart Area</div>
                    </div>
                    <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-2 text-blue-700">ABCD Parameters vs. Line Length</h3>
                        <div id="abcdVsLengthChart" class="w-full h-72 bg-gray-200 rounded-md flex items-center justify-center text-gray-500">Chart Area</div>
                    </div>
                </div>
                <div id="personalizedFeedbackPanel" class="mt-8 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-md hidden">
                    <h3 class="text-lg font-semibold text-blue-700 mb-2">Personalized Feedback</h3>
                    <p id="personalizedFeedbackText" class="text-gray-700"></p>
                </div>
                 <p id="no-analytics-msg" class="text-gray-500 mt-4 hidden">Run some experiments and save them to see analytics.</p>
            </div>

            <div id="comparisonTab" class="tab-panel hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Experiment Comparison</h2>
                <p class="text-gray-600 mb-6">Select up to 3 experiments from the 'Experiment History' tab (using the 'Compare' checkbox) to see a side-by-side comparison here.</p>
                <div id="comparisonContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                <p id="no-comparison-msg" class="text-gray-500 mt-4 hidden">No experiments selected for comparison, or less than 2 experiments selected.</p>
            </div>
        </div>
    </div>

    <script>
        // --- Global State and Configuration ---
        let currentStep = 1;
        let experimentHistory = [];
        let experimentIdCounter = 0;
        let currentSimulationData = {}; // To store parameters of current simulation
        let currentSimulationResults = {}; // To store results of current simulation
        let isDarkMode = false;
        let isVoiceEnabled = false;
        const MAX_COMPARISON_ITEMS = 3;

        // --- DOM Element References ---
        const stepTitleEl = document.getElementById('step-title');
        const stepInstructionEl = document.getElementById('step-instruction');
        const stepContents = {
            1: document.getElementById('step1Content'),
            2: document.getElementById('step2Content'),
            3: document.getElementById('step3Content'),
            4: document.getElementById('step4Content'),
            5: document.getElementById('step5Content'),
            6: document.getElementById('step6Content'),
            7: document.getElementById('step7Content'),
            8: document.getElementById('step8Content'),
        };
        // Input fields
        const lineLengthIn = document.getElementById('lineLength');
        const resistanceIn = document.getElementById('resistance');
        const inductanceIn = document.getElementById('inductance');
        const capacitanceIn = document.getElementById('capacitance');
        const frequencyIn = document.getElementById('frequency');
        const lineModelIn = document.getElementById('lineModel');
        const vrMagIn = document.getElementById('vrMag');
        const vrPhaseIn = document.getElementById('vrPhase');
        const loadTypeIn = document.getElementById('loadType');
        const loadPowerIn = document.getElementById('loadPower');
        const loadPFIn = document.getElementById('loadPF');
        const loadPFTypeIn = document.getElementById('loadPFType');
        const loadZMagIn = document.getElementById('loadZMag');
        const loadZAngleIn = document.getElementById('loadZAngle');
        const loadPowerInputsDiv = document.getElementById('loadPowerInputs');
        const loadImpedanceInputsDiv = document.getElementById('loadImpedanceInputs');

        // User calculation inputs
        const userAIn = document.getElementById('userA');
        const userBIn = document.getElementById('userB');
        const userCIn = document.getElementById('userC');
        const userDIn = document.getElementById('userD');
        const userVsMagIn = document.getElementById('userVsMag');
        const userVRIn = document.getElementById('userVR');
        const userEffIn = document.getElementById('userEff');
        const userCalcFeedbacks = {
            A: document.getElementById('feedbackA'), B: document.getElementById('feedbackB'),
            C: document.getElementById('feedbackC'), D: document.getElementById('feedbackD'),
            VsMag: document.getElementById('feedbackVsMag'), VR: document.getElementById('feedbackVR'),
            Eff: document.getElementById('feedbackEff'),
        };

        // Result display elements
        const resultZEl = document.getElementById('resultZ');
        const resultYEl = document.getElementById('resultY');
        const resultZcEl = document.getElementById('resultZc');
        const resultGammaLEl = document.getElementById('resultGammaL');
        const longLineConstantsDiv = document.getElementById('longLineConstants');
        const resultAEl = document.getElementById('resultA');
        const resultBEl = document.getElementById('resultB');
        const resultCEl = document.getElementById('resultC');
        const resultDEl = document.getElementById('resultD');
        const resultVsEl = document.getElementById('resultVs');
        const resultVsAngleEl = document.getElementById('resultVsAngle');
        const resultIsEl = document.getElementById('resultIs');
        const resultIsAngleEl = document.getElementById('resultIsAngle');
        const resultIrEl = document.getElementById('resultIr');
        const resultIrAngleEl = document.getElementById('resultIrAngle');
        const resultPsEl = document.getElementById('resultPs');
        const resultPrEl = document.getElementById('resultPr');
        const resultQsEl = document.getElementById('resultQs');
        const resultQrEl = document.getElementById('resultQr');
        const resultVREl = document.getElementById('resultVR');
        const resultEffEl = document.getElementById('resultEff');
        const phasorDiagramDiv = document.getElementById('phasorDiagram');

        // History tab elements
        const historyTableBodyEl = document.getElementById('historyTableBody');
        const historyNoteInputEl = document.getElementById('historyNoteInput');
        const noHistoryMsgEl = document.getElementById('no-history-msg');

        // Analytics tab elements
        const vrVsLengthChartDiv = document.getElementById('vrVsLengthChart');
        const effVsPfChartDiv = document.getElementById('effVsPfChart');
        const modelImpactChartDiv = document.getElementById('modelImpactChart');
        const abcdVsLengthChartDiv = document.getElementById('abcdVsLengthChart');
        const personalizedFeedbackPanelEl = document.getElementById('personalizedFeedbackPanel');
        const personalizedFeedbackTextEl = document.getElementById('personalizedFeedbackText');
        const noAnalyticsMsgEl = document.getElementById('no-analytics-msg');

        // Comparison tab elements
        const comparisonContainerEl = document.getElementById('comparisonContainer');
        const noComparisonMsgEl = document.getElementById('no-comparison-msg');
        
        // Modals
        const loadingOverlay = document.getElementById('loading-overlay');
        const alertModal = document.getElementById('alert-modal');
        const alertMessageEl = document.getElementById('alert-message');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessageEl = document.getElementById('confirm-message');
        const theoryModal = document.getElementById('theory-modal');
        const theoryModalContentEl = document.getElementById('theory-modal-content');

        // --- Complex Number Class ---
        class Complex {
            constructor(real, imag) {
                this.real = real || 0;
                this.imag = imag || 0;
            }

            add(other) {
                return new Complex(this.real + other.real, this.imag + other.imag);
            }

            subtract(other) {
                return new Complex(this.real - other.real, this.imag - other.imag);
            }

            multiply(other) {
                // (a+bi)(c+di) = (ac-bd) + (ad+bc)i
                return new Complex(
                    this.real * other.real - this.imag * other.imag,
                    this.real * other.imag + this.imag * other.real
                );
            }

            divide(other) {
                // (a+bi)/(c+di) = [(a+bi)(c-di)] / (c^2+d^2)
                const denominator = other.real * other.real + other.imag * other.imag;
                if (denominator === 0) {
                    showCustomAlert("Error: Division by zero in complex numbers.");
                    return new Complex(Infinity, Infinity); // Or handle error appropriately
                }
                const numerator = this.multiply(other.conjugate());
                return new Complex(numerator.real / denominator, numerator.imag / denominator);
            }

            conjugate() {
                return new Complex(this.real, -this.imag);
            }

            magnitude() {
                return Math.sqrt(this.real * this.real + this.imag * this.imag);
            }

            angleRad() {
                return Math.atan2(this.imag, this.real);
            }

            angleDeg() {
                return this.angleRad() * 180 / Math.PI;
            }

            // e^(a+bi) = e^a * (cos(b) + i sin(b))
            exp() {
                const expReal = Math.exp(this.real);
                return new Complex(expReal * Math.cos(this.imag), expReal * Math.sin(this.imag));
            }
            
            // sqrt(a+bi)
            sqrt() {
                const r = this.magnitude();
                const theta = this.angleRad();
                const sqrtR = Math.sqrt(r);
                return new Complex(sqrtR * Math.cos(theta / 2), sqrtR * Math.sin(theta / 2));
            }


            // sinh(z) = (e^z - e^-z) / 2
            sinh() {
                const exp_z = this.exp();
                const neg_z = new Complex(-this.real, -this.imag);
                const exp_neg_z = neg_z.exp();
                return exp_z.subtract(exp_neg_z).divide(new Complex(2, 0));
            }

            // cosh(z) = (e^z + e^-z) / 2
            cosh() {
                const exp_z = this.exp();
                const neg_z = new Complex(-this.real, -this.imag);
                const exp_neg_z = neg_z.exp();
                return exp_z.add(exp_neg_z).divide(new Complex(2, 0));
            }
            
            toString(precision = 4) {
                const r = this.real.toFixed(precision);
                const i = Math.abs(this.imag).toFixed(precision);
                if (this.imag === 0) return r;
                if (this.real === 0) return (this.imag < 0 ? "-" : "") + "j" + i;
                return `${r} ${this.imag < 0 ? "-" : "+"} j${i}`;
            }

            static fromPolarDeg(magnitude, angleDeg) {
                const angleRad = angleDeg * Math.PI / 180;
                return new Complex(magnitude * Math.cos(angleRad), magnitude * Math.sin(angleRad));
            }
        }

        // --- Utility Functions ---
        function showLoadingOverlay() { loadingOverlay.classList.remove('hidden'); }
        function hideLoadingOverlay() { loadingOverlay.classList.add('hidden'); }

        function showCustomAlert(message) {
            alertMessageEl.textContent = message;
            alertModal.classList.remove('hidden');
            speakMessage(message);
        }

        function showCustomConfirm(message, onConfirm) {
            confirmMessageEl.textContent = message;
            confirmModal.classList.remove('hidden');
            speakMessage(message + " Please confirm.");
            document.getElementById('confirm-yes-btn').onclick = () => {
                confirmModal.classList.add('hidden');
                onConfirm();
            };
        }
        
        function speakMessage(text) {
            if (!isVoiceEnabled || !('speechSynthesis' in window)) return;
            speechSynthesis.cancel(); // Cancel any previous speech
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
        }

        function toggleVoiceInstructions() {
            isVoiceEnabled = !isVoiceEnabled;
            const voiceOnIcon = document.getElementById('voice-on-icon');
            const voiceOffIcon = document.getElementById('voice-off-icon');
            if (isVoiceEnabled) {
                voiceOnIcon.classList.remove('hidden');
                voiceOffIcon.classList.add('hidden');
                speakMessage("Voice instructions enabled.");
            } else {
                voiceOnIcon.classList.add('hidden');
                voiceOffIcon.classList.remove('hidden');
                speechSynthesis.cancel(); // Stop any ongoing speech
            }
            localStorage.setItem('abcdSimVoiceEnabled', isVoiceEnabled);
        }


        // --- Tab Navigation ---
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
                document.getElementById(button.dataset.tab).classList.remove('hidden');
                
                // Re-render Plotly charts if analytics tab is opened
                if (button.dataset.tab === 'analyticsTab' && experimentHistory.length > 0) {
                    setTimeout(renderAnalyticsCharts, 50); // Delay to ensure div is visible
                }
                if (button.dataset.tab === 'simulationTab' && currentStep === 7 && currentSimulationResults.A) {
                     setTimeout(() => renderPhasorDiagram(currentSimulationResults), 50);
                }
                speakMessage(`Switched to ${button.textContent} tab.`);
            });
        });

        // --- Step-by-Step Simulation Flow ---
        const stepDetails = {
            1: { title: "Welcome & Introduction", instruction: "Understand the basics of ABCD parameters and this simulator." },
            2: { title: "Step 1: Transmission Line Configuration", instruction: "Enter the physical parameters of the transmission line and select a model." },
            3: { title: "Step 2: Review Entered Parameters", instruction: "Verify the line parameters and model you've selected." },
            4: { title: "Step 3: Theoretical Background", instruction: "Learn about the formulas for the selected transmission line model." },
            5: { title: "Step 4: Load Conditions", instruction: "Specify the receiving end voltage and load characteristics." },
            6: { title: "Step 5: Self-Calculation (Optional)", instruction: "Estimate the key performance metrics before viewing the simulation results." },
            7: { title: "Step 6: Simulation Results", instruction: "View the calculated ABCD parameters and performance metrics." },
            8: { title: "Step 7: Analysis & Further Experimentation", instruction: "Reflect on the results and consider further experiments." }
        };

        function updateStepUI() {
            for (const step in stepContents) {
                stepContents[step].classList.add('hidden');
            }
            stepContents[currentStep].classList.remove('hidden');
            stepTitleEl.textContent = stepDetails[currentStep].title;
            stepInstructionEl.textContent = stepDetails[currentStep].instruction;
            speakMessage(stepDetails[currentStep].title + ". " + stepDetails[currentStep].instruction);
            window.scrollTo(0,0); // Scroll to top
        }
        
        function nextStep() { if (currentStep < 8) currentStep++; updateStepUI(); }
        function prevStep() { if (currentStep > 1) currentStep--; updateStepUI(); }
        function goToStep(step) { currentStep = step; updateStepUI(); }

        // --- Input Handling and Default Values ---
        function loadDefaultParameters() {
            lineLengthIn.value = "100";
            resistanceIn.value = "0.1";
            inductanceIn.value = "1.0";
            capacitanceIn.value = "10"; // nF/km
            frequencyIn.value = "50";
            lineModelIn.value = "mediumPi";
            vrMagIn.value = "220"; // kV L-L
            vrPhaseIn.value = "0";
            loadTypeIn.value = "power";
            loadPowerIn.value = "50"; // MW
            loadPFIn.value = "0.8";
            loadPFTypeIn.value = "lagging";
            loadZMagIn.value = "100";
            loadZAngleIn.value = "36.87";
            toggleLoadInputFields();
            speakMessage("Default parameters loaded.");
        }

        loadTypeIn.addEventListener('change', toggleLoadInputFields);
        function toggleLoadInputFields() {
            if (loadTypeIn.value === 'power') {
                loadPowerInputsDiv.classList.remove('hidden');
                loadImpedanceInputsDiv.classList.add('hidden');
            } else {
                loadPowerInputsDiv.classList.add('hidden');
                loadImpedanceInputsDiv.classList.remove('hidden');
            }
        }

        function getSimulationParameters() {
            currentSimulationData = {
                lineLength: parseFloat(lineLengthIn.value),
                R_per_km: parseFloat(resistanceIn.value),
                L_per_km: parseFloat(inductanceIn.value) / 1000, // convert mH to H
                C_per_km: parseFloat(capacitanceIn.value) * 1e-9, // convert nF to F
                frequency: parseFloat(frequencyIn.value),
                lineModel: lineModelIn.value,
                Vr_mag_LL: parseFloat(vrMagIn.value), // kV Line-to-Line
                Vr_phase_deg: parseFloat(vrPhaseIn.value),
                loadType: loadTypeIn.value,
                loadPower_MW_3ph: loadTypeIn.value === 'power' ? parseFloat(loadPowerIn.value) : null,
                loadPF: loadTypeIn.value === 'power' ? parseFloat(loadPFIn.value) : null,
                loadPFType: loadTypeIn.value === 'power' ? loadPFTypeIn.value : null,
                loadZ_mag: loadTypeIn.value === 'impedance' ? parseFloat(loadZMagIn.value) : null,
                loadZ_angle_deg: loadTypeIn.value === 'impedance' ? parseFloat(loadZAngleIn.value) : null,
            };

            // Basic Validation (can be expanded)
            for (const key in currentSimulationData) {
                if (typeof currentSimulationData[key] === 'number' && isNaN(currentSimulationData[key]) && key !== 'loadPower_MW_3ph' && key !== 'loadPF' && key !== 'loadZ_mag' && key !== 'loadZ_angle_deg') { // Allow nulls for conditional fields
                     showCustomAlert(`Invalid input for ${key}. Please enter a valid number.`);
                     return null;
                }
            }
            if (currentSimulationData.lineLength <=0 || currentSimulationData.frequency <=0) {
                showCustomAlert("Line length and frequency must be positive."); return null;
            }
            if (currentSimulationData.R_per_km < 0 || currentSimulationData.L_per_km < 0 || currentSimulationData.C_per_km < 0) {
                showCustomAlert("R, L, C per km cannot be negative."); return null;
            }
             if (currentSimulationData.loadType === 'power' && (currentSimulationData.loadPF <= 0 || currentSimulationData.loadPF > 1)) {
                showCustomAlert("Power factor must be between 0 (exclusive) and 1 (inclusive)."); return null;
            }
            return currentSimulationData;
        }
        
        function displayReviewData(params) {
            const reviewDiv = document.getElementById('review-data-display');
            reviewDiv.innerHTML = `
                <p><strong>Line Length:</strong> ${params.lineLength} km</p>
                <p><strong>Resistance (R/km):</strong> ${params.R_per_km} Ω/km</p>
                <p><strong>Inductance (L/km):</strong> ${params.L_per_km * 1000} mH/km</p>
                <p><strong>Capacitance (C/km):</strong> ${params.C_per_km / 1e-9} nF/km</p>
                <p><strong>Frequency:</strong> ${params.frequency} Hz</p>
                <p><strong>Line Model:</strong> ${document.querySelector(`#lineModel option[value="${params.lineModel}"]`).textContent}</p>
            `;
        }

        function displayTheory(model) {
            let theoryHtml = `
                <p class="mb-2">The general ABCD parameters relate sending end ($V_S, I_S$) and receiving end ($V_R, I_R$) quantities:</p>
                <p class="font-mono text-center text-lg my-2">$$ V_S = A V_R + B I_R $$</p>
                <p class="font-mono text-center text-lg my-2">$$ I_S = C V_R + D I_R $$</p>
                <p class="mb-2">For a <strong>${document.querySelector(`#lineModel option[value="${model}"]`).textContent}</strong>:</p>
            `;
            // Note: Z = total series impedance, Y = total shunt admittance
            // z = series impedance per unit length, y = shunt admittance per unit length
            // l = line length
            switch(model) {
                case 'short':
                    theoryHtml += `
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>The effects of shunt capacitance are neglected.</li>
                            <li>$A = 1$</li>
                            <li>$B = Z = (R + j\\omega L) \\times l$</li>
                            <li>$C = 0$</li>
                            <li>$D = 1$</li>
                        </ul>`;
                    break;
                case 'mediumT':
                    theoryHtml += `
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>The total shunt admittance $Y$ is concentrated at the center, and the series impedance $Z$ is split into two halves.</li>
                            <li>$Z = (R + j\\omega L) \\times l$</li>
                            <li>$Y = (G + j\\omega C) \\times l$ (Assuming $G=0$)</li>
                            <li>$A = D = 1 + \\frac{ZY}{2}$</li>
                            <li>$B = Z \\left(1 + \\frac{ZY}{4}\\right)$</li>
                            <li>$C = Y$</li>
                        </ul>`;
                    break;
                case 'mediumPi':
                    theoryHtml += `
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>The total series impedance $Z$ is in the middle, and the total shunt admittance $Y$ is split into two halves, one at each end.</li>
                            <li>$Z = (R + j\\omega L) \\times l$</li>
                            <li>$Y = (G + j\\omega C) \\times l$ (Assuming $G=0$)</li>
                            <li>$A = D = 1 + \\frac{ZY}{2}$</li>
                            <li>$B = Z$</li>
                            <li>$C = Y \\left(1 + \\frac{ZY}{4}\\right)$</li>
                        </ul>`;
                    break;
                case 'long':
                    theoryHtml += `
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Parameters are distributed throughout the line.</li>
                            <li>Let $z = R + j\\omega L$ (series impedance per unit length)</li>
                            <li>Let $y = G + j\\omega C$ (shunt admittance per unit length, assuming $G=0$)</li>
                            <li>Propagation constant: $\\gamma = \\sqrt{zy}$</li>
                            <li>Characteristic impedance: $Z_C = \\sqrt{z/y}$</li>
                            <li>$A = D = \\cosh(\\gamma l)$</li>
                            <li>$B = Z_C \\sinh(\\gamma l)$</li>
                            <li>$C = \\frac{1}{Z_C} \\sinh(\\gamma l)$</li>
                        </ul>`;
                    break;
            }
            document.getElementById('theory-display').innerHTML = theoryHtml;
            theoryModalContentEl.innerHTML = theoryHtml + `<p class="mt-4 text-sm text-gray-600">Note: $l$ is the total line length. $Z$ and $Y$ in the Medium line formulas represent total impedance and admittance respectively.</p>`;
            if (window.MathJax) {
                window.MathJax.typesetPromise([document.getElementById('theory-display'), theoryModalContentEl]);
            }
        }
        
        // --- Calculation Logic ---
        function calculateLineConstantsAndABCD(params) {
            const omega = 2 * Math.PI * params.frequency;
            const R_total = params.R_per_km * params.lineLength;
            const L_total = params.L_per_km * params.lineLength; // Already in H
            const C_total = params.C_per_km * params.lineLength; // Already in F
            
            const Z_total = new Complex(R_total, omega * L_total);
            const Y_total = new Complex(0, omega * C_total); // Assuming G=0

            let A, B, C, D;
            let Zc, gamma_l; // For long line

            switch (params.lineModel) {
                case 'short':
                    A = new Complex(1, 0);
                    B = Z_total;
                    C = new Complex(0, 0);
                    D = new Complex(1, 0);
                    break;
                case 'mediumT':
                    // A = D = 1 + ZY/2
                    // B = Z(1 + ZY/4)
                    // C = Y
                    const ZY_div_2_T = Z_total.multiply(Y_total).divide(new Complex(2, 0));
                    A = new Complex(1, 0).add(ZY_div_2_T);
                    D = A;
                    B = Z_total.multiply(new Complex(1, 0).add(ZY_div_2_T.divide(new Complex(2,0))));
                    C = Y_total;
                    break;
                case 'mediumPi':
                    // A = D = 1 + ZY/2
                    // B = Z
                    // C = Y(1 + ZY/4)
                    const ZY_div_2_Pi = Z_total.multiply(Y_total).divide(new Complex(2, 0));
                    A = new Complex(1, 0).add(ZY_div_2_Pi);
                    D = A;
                    B = Z_total;
                    C = Y_total.multiply(new Complex(1, 0).add(ZY_div_2_Pi.divide(new Complex(2,0))));
                    break;
                case 'long':
                    const z_unit = new Complex(params.R_per_km, omega * params.L_per_km);
                    const y_unit = new Complex(0, omega * params.C_per_km);
                    
                    const gamma_unit = z_unit.multiply(y_unit).sqrt(); // propagation constant per unit length
                    Zc = z_unit.divide(y_unit).sqrt(); // characteristic impedance
                    
                    gamma_l = gamma_unit.multiply(new Complex(params.lineLength, 0)); // gamma * l
                    
                    A = gamma_l.cosh();
                    D = A;
                    B = Zc.multiply(gamma_l.sinh());
                    C = gamma_l.sinh().divide(Zc);
                    break;
                default:
                    showCustomAlert("Unknown line model selected.");
                    return null;
            }
            return { Z_total, Y_total, A, B, C, D, Zc, gamma_l };
        }

        function calculatePerformance(params, abcdResults) {
            const { A, B, C, D } = abcdResults;
            
            // Receiving end voltage per phase (Line-to-Neutral)
            const Vr_mag_LN = params.Vr_mag_LL / Math.sqrt(3);
            const Vr_phase = Complex.fromPolarDeg(Vr_mag_LN, params.Vr_phase_deg);

            let Ir_phase; // Receiving end current per phase

            if (params.loadType === 'power') {
                // P_3ph = sqrt(3) * V_LL * I_L * pf  => I_L = P_3ph / (sqrt(3) * V_LL * pf)
                // P_1ph = P_3ph / 3
                const P_1ph_W = (params.loadPower_MW_3ph * 1e6) / 3;
                const pf_angle_rad = Math.acos(params.loadPF) * (params.loadPFType === 'lagging' ? 1 : -1);
                
                // S_1ph = P_1ph / pf
                // |Ir| = S_1ph / |Vr_LN| = (P_1ph / pf) / |Vr_LN|
                const Ir_mag = P_1ph_W / (params.loadPF * Vr_mag_LN);
                const Ir_angle_deg = params.Vr_phase_deg - (pf_angle_rad * 180 / Math.PI); // Current lags/leads voltage
                Ir_phase = Complex.fromPolarDeg(Ir_mag, Ir_angle_deg);
            } else { // impedance load
                // ZL is per phase
                const ZL_phase = Complex.fromPolarDeg(params.loadZ_mag, params.loadZ_angle_deg);
                if (ZL_phase.magnitude() === 0) {
                    showCustomAlert("Load impedance cannot be zero.");
                    return null; // Or handle as short circuit appropriately
                }
                Ir_phase = Vr_phase.divide(ZL_phase);
            }

            // Vs = A*Vr + B*Ir
            const Vs_phase = A.multiply(Vr_phase).add(B.multiply(Ir_phase));
            // Is = C*Vr + D*Ir
            const Is_phase = C.multiply(Vr_phase).add(D.multiply(Ir_phase));

            // Convert back to Line-to-Line for Vs display if needed, but calculations are per phase
            const Vs_mag_LN = Vs_phase.magnitude();
            const Vs_mag_LL = Vs_mag_LN * Math.sqrt(3);
            const Vs_angle_deg = Vs_phase.angleDeg();

            // Power Calculations (per phase, then multiply by 3 for 3-phase)
            // Pr_1ph = Vr * Ir_conj
            const Pr_complex_1ph = Vr_phase.multiply(Ir_phase.conjugate());
            const Pr_1ph_W = Pr_complex_1ph.real;
            const Qr_1ph_VAR = Pr_complex_1ph.imag;

            // Ps_1ph = Vs * Is_conj
            const Ps_complex_1ph = Vs_phase.multiply(Is_phase.conjugate());
            const Ps_1ph_W = Ps_complex_1ph.real;
            const Qs_1ph_VAR = Ps_complex_1ph.imag;

            const Pr_3ph_MW = (Pr_1ph_W * 3) / 1e6;
            const Qr_3ph_MVAr = (Qr_1ph_VAR * 3) / 1e6;
            const Ps_3ph_MW = (Ps_1ph_W * 3) / 1e6;
            const Qs_3ph_MVAr = (Qs_1ph_VAR * 3) / 1e6;

            // Voltage Regulation: VR = (|Vs_LN|/|A| - |Vr_LN_FL|) / |Vr_LN_FL| * 100
            // Or |Vr_NL| = |Vs_LL| / |A| (assuming Vs_LL is maintained) then use Vr_NL_LN
            // Using |Vr_NL_LN| = |Vs_LN| / |A|
            const Vr_NL_LN_mag = Vs_mag_LN / A.magnitude();
            const voltageRegulation = ((Vr_NL_LN_mag - Vr_mag_LN) / Vr_mag_LN) * 100;
            
            // Efficiency: eta = Pr_3ph / Ps_3ph * 100
            const efficiency = (Ps_1ph_W === 0) ? 0 : (Pr_1ph_W / Ps_1ph_W) * 100;

            return {
                Vs_mag_LL_kV: Vs_mag_LL, Vs_angle_deg: Vs_angle_deg,
                Is_mag_A: Is_phase.magnitude(), Is_angle_deg: Is_phase.angleDeg(),
                Ir_mag_A: Ir_phase.magnitude(), Ir_angle_deg: Ir_phase.angleDeg(),
                Ps_MW_3ph: Ps_3ph_MW, Pr_MW_3ph: Pr_3ph_MW,
                Qs_MVAr_3ph: Qs_3ph_MVAr, Qr_MVAr_3ph: Qr_3ph_MVAr,
                voltageRegulation_percent: voltageRegulation,
                efficiency_percent: efficiency,
                // For phasor diagram
                Vr_phasor: Vr_phase, Ir_phasor: Ir_phase, Vs_phasor: Vs_phase, Is_phasor: Is_phase
            };
        }
        
        function runSimulation() {
            const params = getSimulationParameters();
            if (!params) return null;

            showLoadingOverlay();
            // Simulate async calculation
            return new Promise(resolve => {
                setTimeout(() => {
                    const abcd = calculateLineConstantsAndABCD(params);
                    if (!abcd) {
                        hideLoadingOverlay();
                        resolve(null);
                        return;
                    }
                    const performance = calculatePerformance(params, abcd);
                    if (!performance) {
                        hideLoadingOverlay();
                        resolve(null);
                        return;
                    }
                    
                    currentSimulationResults = { ...params, ...abcd, ...performance };
                    hideLoadingOverlay();
                    resolve(currentSimulationResults);
                }, 200); // Small delay to show loader
            });
        }

        // --- User Self-Calculation ---
        function checkUserCalculations() {
            if (!currentSimulationResults || !currentSimulationResults.A) {
                showCustomAlert("Please run a simulation first to get actual values.");
                return;
            }
            let allCorrect = true;
            const tolerance = 0.05; // 5% tolerance

            function checkValue(userInputEl, actualValue, feedbackEl, paramName, isMagnitude = true) {
                const userVal = parseFloat(userInputEl.value);
                if (isNaN(userVal)) {
                    feedbackEl.textContent = "Enter a number.";
                    feedbackEl.className = "user-calc-feedback incorrect";
                    allCorrect = false;
                    return;
                }
                const actual = isMagnitude ? actualValue.magnitude() : actualValue;
                const error = Math.abs(userVal - actual) / (Math.abs(actual) < 1e-9 ? 1 : Math.abs(actual)); // Avoid div by zero for actual=0

                if (error <= tolerance || (Math.abs(userVal) < 1e-9 && Math.abs(actual) < 1e-9) ) { // Also correct if both are near zero
                    feedbackEl.textContent = `Correct! (Actual: ${actual.toFixed(3)})`;
                    feedbackEl.className = "user-calc-feedback correct";
                } else {
                    feedbackEl.textContent = `Incorrect. (Actual: ${actual.toFixed(3)})`;
                    feedbackEl.className = "user-calc-feedback incorrect";
                    allCorrect = false;
                }
            }
            
            // For C, convert to mS for user input if actual is in S
            const actualC_mag_mS = currentSimulationResults.C.magnitude() * 1000;

            checkValue(userAIn, currentSimulationResults.A, userCalcFeedbacks.A, "A");
            checkValue(userBIn, currentSimulationResults.B, userCalcFeedbacks.B, "B");
            checkValue(userCIn, actualC_mag_mS, userCalcFeedbacks.C, "C (mS)", false); // C is compared in mS
            checkValue(userDIn, currentSimulationResults.D, userCalcFeedbacks.D, "D");
            checkValue(userVsMagIn, currentSimulationResults.Vs_mag_LL_kV, userCalcFeedbacks.VsMag, "Vs Mag (kV L-L)", false);
            checkValue(userVRIn, currentSimulationResults.voltageRegulation_percent, userCalcFeedbacks.VR, "VR (%)", false);
            checkValue(userEffIn, currentSimulationResults.efficiency_percent, userCalcFeedbacks.Eff, "Efficiency (%)", false);

            if (allCorrect) {
                speakMessage("Excellent! All your estimates are within 5% tolerance.");
            } else {
                speakMessage("Some estimates need adjustment. Check the feedback.");
            }
        }
        
        function clearUserCalcFeedback() {
            Object.values(userCalcFeedbacks).forEach(el => {
                el.textContent = '';
                el.className = 'user-calc-feedback text-sm mt-1';
            });
            [userAIn, userBIn, userCIn, userDIn, userVsMagIn, userVRIn, userEffIn].forEach(input => input.value = '');
        }

        // --- Display Results ---
        function displayResults(results) {
            resultZEl.textContent = results.Z_total.toString();
            resultYEl.textContent = results.Y_total.toString(6); // Higher precision for Y

            if (results.lineModel === 'long' && results.Zc && results.gamma_l) {
                longLineConstantsDiv.classList.remove('hidden');
                resultZcEl.textContent = results.Zc.toString();
                resultGammaLEl.textContent = results.gamma_l.toString();
            } else {
                longLineConstantsDiv.classList.add('hidden');
            }

            resultAEl.textContent = results.A.toString();
            resultBEl.textContent = results.B.toString();
            resultCEl.textContent = results.C.toString(6); // Higher precision for C
            resultDEl.textContent = results.D.toString();

            resultVsEl.textContent = results.Vs_mag_LL_kV.toFixed(2);
            resultVsAngleEl.textContent = results.Vs_angle_deg.toFixed(2);
            resultIsEl.textContent = results.Is_mag_A.toFixed(3);
            resultIsAngleEl.textContent = results.Is_angle_deg.toFixed(2);
            resultIrEl.textContent = results.Ir_mag_A.toFixed(3);
            resultIrAngleEl.textContent = results.Ir_angle_deg.toFixed(2);
            resultPsEl.textContent = results.Ps_MW_3ph.toFixed(3);
            resultPrEl.textContent = results.Pr_MW_3ph.toFixed(3);
            resultQsEl.textContent = results.Qs_MVAr_3ph.toFixed(3);
            resultQrEl.textContent = results.Qr_MVAr_3ph.toFixed(3);
            resultVREl.textContent = results.voltageRegulation_percent.toFixed(2);
            resultEffEl.textContent = results.efficiency_percent.toFixed(2);
            
            renderPhasorDiagram(results);
        }
        
        function renderPhasorDiagram(results) {
            if (!results.Vr_phasor) { // Check if results are available
                phasorDiagramDiv.innerHTML = '<p class="text-gray-500">Phasor diagram data not available.</p>';
                return;
            }
            try {
                Plotly.purge(phasorDiagramDiv); // Clear previous plot

                const Vr = results.Vr_phasor; // Reference phasor
                const Ir = results.Ir_phasor;
                const Vs = results.Vs_phasor;
                const Is = results.Is_phasor;

                // Scale factor for currents to make them visible relative to voltages
                // This is a heuristic and might need adjustment based on typical values
                const maxVoltageMag = Math.max(Vr.magnitude(), Vs.magnitude());
                const maxCurrentMag = Math.max(Ir.magnitude(), Is.magnitude());
                let currentScale = 1;
                if (maxCurrentMag > 0 && maxVoltageMag > 0) {
                     currentScale = (maxVoltageMag / maxCurrentMag) * 0.5; // Scale current to be roughly half the voltage magnitude for display
                }
                if (maxCurrentMag === 0) currentScale = 0; // Avoid issues if current is zero

                const data = [
                    { x: [0, Vr.real], y: [0, Vr.imag], type: 'scatter', mode: 'lines', name: '$V_R$', line: { color: 'blue', width: 2 }, hoverinfo: `text`, text: `Vr: ${Vr.magnitude().toFixed(2)} ∠ ${Vr.angleDeg().toFixed(1)}°` },
                    { x: [0, Ir.real * currentScale], y: [0, Ir.imag * currentScale], type: 'scatter', mode: 'lines', name: '$I_R$ (scaled)', line: { color: 'red', width: 2, dash: 'dash' }, hoverinfo: `text`, text: `Ir: ${Ir.magnitude().toFixed(2)} ∠ ${Ir.angleDeg().toFixed(1)}°` },
                    { x: [0, Vs.real], y: [0, Vs.imag], type: 'scatter', mode: 'lines', name: '$V_S$', line: { color: 'green', width: 2 }, hoverinfo: `text`, text: `Vs: ${Vs.magnitude().toFixed(2)} ∠ ${Vs.angleDeg().toFixed(1)}°` },
                    { x: [0, Is.real * currentScale], y: [0, Is.imag * currentScale], type: 'scatter', mode: 'lines', name: '$I_S$ (scaled)', line: { color: 'purple', width: 2, dash: 'dash' }, hoverinfo: `text`, text: `Is: ${Is.magnitude().toFixed(2)} ∠ ${Is.angleDeg().toFixed(1)}°` }
                ];
                
                // Add arrows
                const arrowHead = (x, y, angle, color) => ({
                    x: [x, x - 0.1 * Math.cos(angle - Math.PI / 6), x - 0.1 * Math.cos(angle + Math.PI / 6), x],
                    y: [y, y - 0.1 * Math.sin(angle - Math.PI / 6), y - 0.1 * Math.sin(angle + Math.PI / 6), y],
                    type: 'scatter', mode: 'lines', fill: 'toself', fillcolor: color, line: { color: color }, hoverinfo: 'skip', showlegend: false
                });

                // Determine appropriate axis range
                const allReals = [0, Vr.real, Ir.real * currentScale, Vs.real, Is.real * currentScale];
                const allImags = [0, Vr.imag, Ir.imag * currentScale, Vs.imag, Is.imag * currentScale];
                const maxAbsReal = Math.max(...allReals.map(Math.abs));
                const maxAbsImag = Math.max(...allImags.map(Math.abs));
                const rangeFactor = 1.2;

                const layout = {
                    title: 'Phasor Diagram',
                    xaxis: { title: 'Real Axis', range: [-maxAbsReal * rangeFactor, maxAbsReal * rangeFactor], zeroline: true, zerolinecolor: isDarkMode ? '#555' : '#ccc' },
                    yaxis: { title: 'Imaginary Axis', range: [-maxAbsImag * rangeFactor, maxAbsImag * rangeFactor], zeroline: true, zerolinecolor: isDarkMode ? '#555' : '#ccc', scaleanchor: "x", scaleratio: 1 },
                    showlegend: true,
                    width: phasorDiagramDiv.clientWidth,
                    height: phasorDiagramDiv.clientHeight, // Use clientHeight for better fit
                    paper_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', // Match theme
                    plot_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb',  // Match theme
                    font: { color: isDarkMode ? '#e2e8f0' : '#374151' },
                    margin: { l: 50, r: 20, b: 50, t: 50, pad: 4 },
                    legend: { bgcolor: isDarkMode ? 'rgba(45,55,72,0.7)' : 'rgba(255,255,255,0.7)', bordercolor: isDarkMode ? '#4A5568' : '#E5E7EB' }
                };
                Plotly.newPlot(phasorDiagramDiv, data, layout, {responsive: true});
            } catch (e) {
                console.error("Error rendering phasor diagram:", e);
                phasorDiagramDiv.innerHTML = '<p class="text-red-500">Error rendering phasor diagram. Check console.</p>';
            }
        }


        // --- Experiment History ---
        function loadHistory() {
            const storedHistory = localStorage.getItem('abcdSimHistory');
            if (storedHistory) {
                experimentHistory = JSON.parse(storedHistory);
                experimentIdCounter = experimentHistory.length > 0 ? Math.max(...experimentHistory.map(e => e.id)) : 0;
            }
            renderHistoryTable();
            updateAnalyticsAvailability();
            updateComparisonAvailability();
        }

        function saveHistory() {
            localStorage.setItem('abcdSimHistory', JSON.stringify(experimentHistory));
        }

        function addExperimentToHistory(results, note = "") {
            experimentIdCounter++;
            const newEntry = {
                id: experimentIdCounter,
                timestamp: new Date().toLocaleString(),
                params: { ...currentSimulationData }, // Store a copy of parameters used for this run
                results: { // Store key results
                    A_mag: results.A.magnitude(), A_angle: results.A.angleDeg(),
                    B_mag: results.B.magnitude(), B_angle: results.B.angleDeg(),
                    C_mag: results.C.magnitude(), C_angle: results.C.angleDeg(),
                    D_mag: results.D.magnitude(), D_angle: results.D.angleDeg(),
                    Vs_mag_LL_kV: results.Vs_mag_LL_kV, Vs_angle_deg: results.Vs_angle_deg,
                    voltageRegulation_percent: results.voltageRegulation_percent,
                    efficiency_percent: results.efficiency_percent,
                },
                fullResults: { ...results }, // Store all results for detailed view or re-plot
                note: note || historyNoteInputEl.value.trim() || "(No note)"
            };
            experimentHistory.push(newEntry);
            saveHistory();
            renderHistoryTable();
            updateAnalyticsAvailability();
            updateComparisonAvailability();
            historyNoteInputEl.value = ''; // Clear note input
            speakMessage("Experiment saved to history.");
        }

        function renderHistoryTable() {
            historyTableBodyEl.innerHTML = '';
            if (experimentHistory.length === 0) {
                noHistoryMsgEl.classList.remove('hidden');
                return;
            }
            noHistoryMsgEl.classList.add('hidden');

            experimentHistory.slice().reverse().forEach(entry => { // Show newest first
                const row = historyTableBodyEl.insertRow();
                row.insertCell().textContent = entry.id;
                row.insertCell().textContent = entry.timestamp;
                row.insertCell().textContent = document.querySelector(`#lineModel option[value="${entry.params.lineModel}"]`).textContent.substring(0,15);
                row.insertCell().textContent = entry.params.lineLength.toFixed(1);
                const loadInfo = entry.params.loadType === 'power' ? `${entry.params.loadPower_MW_3ph.toFixed(1)}MW, ${entry.params.loadPF.toFixed(2)}PF ${entry.params.loadPFType.substring(0,3)}` : `${entry.params.loadZ_mag.toFixed(1)}Ω ∠${entry.params.loadZ_angle_deg.toFixed(1)}°`;
                row.insertCell().textContent = loadInfo;
                row.insertCell().textContent = entry.results.A_mag.toFixed(4);
                row.insertCell().textContent = entry.results.B_mag.toFixed(2);
                row.insertCell().textContent = entry.results.voltageRegulation_percent.toFixed(2);
                row.insertCell().textContent = entry.results.efficiency_percent.toFixed(2);
                row.insertCell().textContent = entry.note.substring(0, 20) + (entry.note.length > 20 ? '...' : '');
                
                const actionsCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.56 0c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>`;
                deleteBtn.title = "Delete Entry";
                deleteBtn.className = "text-red-500 hover:text-red-700 p-1";
                deleteBtn.onclick = () => deleteHistoryEntry(entry.id);
                actionsCell.appendChild(deleteBtn);

                const compareCell = row.insertCell();
                const compareCheckbox = document.createElement('input');
                compareCheckbox.type = 'checkbox';
                compareCheckbox.className = 'form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500';
                compareCheckbox.dataset.experimentId = entry.id;
                compareCheckbox.onchange = handleCompareCheckboxChange;
                compareCell.appendChild(compareCheckbox);
            });
        }

        function deleteHistoryEntry(id) {
            showCustomConfirm(`Are you sure you want to delete experiment ID ${id}?`, () => {
                experimentHistory = experimentHistory.filter(e => e.id !== id);
                saveHistory();
                renderHistoryTable();
                updateAnalyticsAvailability();
                renderComparisonView(); // Update comparison view as an item might be removed
                speakMessage(`Experiment ID ${id} deleted.`);
            });
        }

        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
            showCustomConfirm("Are you sure you want to clear ALL experiment history? This cannot be undone.", () => {
                experimentHistory = [];
                experimentIdCounter = 0;
                saveHistory();
                renderHistoryTable();
                updateAnalyticsAvailability();
                renderComparisonView(); // Clear comparison view
                speakMessage("All experiment history cleared.");
            });
        });
        
        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            if (experimentHistory.length === 0) {
                showCustomAlert("No history to export.");
                return;
            }
            const headers = ["ID", "Timestamp", "Model", "Length_km", "R_ohm_km", "L_mH_km", "C_nF_km", "Freq_Hz", "Vr_kV_LL", "Vr_Phase_deg", "Load_Type", "Load_Power_MW", "Load_PF", "Load_PF_Type", "Load_Z_Mag_ohm", "Load_Z_Angle_deg", "A_mag", "A_angle_deg", "B_mag_ohm", "B_angle_deg", "C_mag_S", "C_angle_deg", "D_mag", "D_angle_deg", "Vs_kV_LL", "Vs_Angle_deg", "VR_percent", "Efficiency_percent", "Note"];
            const rows = experimentHistory.map(e => [
                e.id, e.timestamp, e.params.lineModel, e.params.lineLength, e.params.R_per_km, e.params.L_per_km * 1000, e.params.C_per_km / 1e-9, e.params.frequency,
                e.params.Vr_mag_LL, e.params.Vr_phase_deg, e.params.loadType,
                e.params.loadPower_MW_3ph, e.params.loadPF, e.params.loadPFType,
                e.params.loadZ_mag, e.params.loadZ_angle_deg,
                e.results.A_mag, e.results.A_angle, e.results.B_mag, e.results.B_angle,
                e.results.C_mag, e.results.C_angle, e.results.D_mag, e.results.D_angle,
                e.results.Vs_mag_LL_kV, e.results.Vs_angle_deg, e.results.voltageRegulation_percent, e.results.efficiency_percent,
                `"${e.note.replace(/"/g, '""')}"` // Escape quotes in note
            ].join(','));
            const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "abcd_simulator_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            speakMessage("History exported to CSV.");
        });


        // --- Analytics Dashboard ---
        function updateAnalyticsAvailability() {
            if (experimentHistory.length > 0) {
                noAnalyticsMsgEl.classList.add('hidden');
                renderAnalyticsCharts(); // Re-render if data is now available
            } else {
                noAnalyticsMsgEl.classList.remove('hidden');
                // Clear charts
                [vrVsLengthChartDiv, effVsPfChartDiv, modelImpactChartDiv, abcdVsLengthChartDiv].forEach(div => {
                    Plotly.purge(div);
                    div.innerHTML = 'Chart Area';
                });
                personalizedFeedbackPanelEl.classList.add('hidden');
            }
        }

        function renderAnalyticsCharts() {
            if (experimentHistory.length === 0) return;
            // Placeholder: Actual chart rendering logic would go here
            // For simplicity, just updating text. In full implementation, use Plotly.
            try {
                // Chart 1: VR vs Length
                const vrData = experimentHistory.map(e => ({ x: e.params.lineLength, y: e.results.voltageRegulation_percent, text: `ID: ${e.id}<br>Model: ${e.params.lineModel}` }));
                Plotly.newPlot(vrVsLengthChartDiv, [{ x: vrData.map(d=>d.x), y: vrData.map(d=>d.y), mode: 'markers', type: 'scatter', text: vrData.map(d=>d.text), hoverinfo: 'text+x+y' }], 
                              { title: 'VR vs Line Length', xaxis: {title: 'Line Length (km)'}, yaxis: {title: 'Voltage Regulation (%)'}, paper_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', plot_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', font: { color: isDarkMode ? '#e2e8f0' : '#374151' }, margin: { t:30, l:50, r:20, b:40 } }, {responsive: true});

                // Chart 2: Efficiency vs Load PF (only for 'power' load type)
                const effData = experimentHistory.filter(e => e.params.loadType === 'power').map(e => ({ x: e.params.loadPF, y: e.results.efficiency_percent, text: `ID: ${e.id}<br>Load: ${e.params.loadPower_MW_3ph} MW` }));
                Plotly.newPlot(effVsPfChartDiv, [{ x: effData.map(d=>d.x), y: effData.map(d=>d.y), mode: 'markers', type: 'scatter', text: effData.map(d=>d.text), hoverinfo: 'text+x+y' }], 
                              { title: 'Efficiency vs Load PF', xaxis: {title: 'Load Power Factor'}, yaxis: {title: 'Efficiency (%)'}, paper_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', plot_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', font: { color: isDarkMode ? '#e2e8f0' : '#374151' }, margin: { t:30, l:50, r:20, b:40 } }, {responsive: true});
                
                // Chart 3: Impact of Line Model on Vs (simplified: show Vs for different models if other params similar)
                // This requires more complex data aggregation, for now a placeholder
                const modelImpactData = experimentHistory.map(e => ({x: e.params.lineModel, y: e.results.Vs_mag_LL_kV, text: `ID: ${e.id}<br>Length: ${e.params.lineLength}km`}));
                 Plotly.newPlot(modelImpactChartDiv, [{ x: modelImpactData.map(d=>d.x), y: modelImpactData.map(d=>d.y), type: 'box', text: modelImpactData.map(d=>d.text), hoverinfo: 'text+y' }], 
                               { title: 'Vs Magnitude by Line Model', xaxis: {title: 'Line Model'}, yaxis: {title: 'Vs Magnitude (kV L-L)'}, paper_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', plot_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', font: { color: isDarkMode ? '#e2e8f0' : '#374151' }, margin: { t:30, l:50, r:20, b:40 } }, {responsive: true});


                // Chart 4: ABCD Parameters vs Line Length
                const aMagData = experimentHistory.map(e => e.results.A_mag);
                const bMagData = experimentHistory.map(e => e.results.B_mag);
                const cMagData = experimentHistory.map(e => e.results.C_mag * 1000); // in mS
                const dMagData = experimentHistory.map(e => e.results.D_mag);
                const lengths = experimentHistory.map(e => e.params.lineLength);

                Plotly.newPlot(abcdVsLengthChartDiv, [
                    { x: lengths, y: aMagData, mode: 'lines+markers', name: '|A|' },
                    { x: lengths, y: bMagData, mode: 'lines+markers', name: '|B| (Ω)', yaxis: 'y2'},
                    // { x: lengths, y: cMagData, mode: 'lines+markers', name: '|C| (mS)', yaxis: 'y3'}, // Plotly has issues with many y-axes easily
                    // { x: lengths, y: dMagData, mode: 'lines+markers', name: '|D|' }
                ], { 
                    title: 'ABCD Magnitudes vs Line Length', 
                    xaxis: {title: 'Line Length (km)'}, 
                    yaxis: {title: '|A| magnitude'},
                    yaxis2: { title: '|B| magnitude (Ω)', overlaying: 'y', side: 'right', showgrid: false},
                    // yaxis3: { title: '|C| magnitude (mS)', overlaying: 'y', side: 'right', position: 0.85, showgrid: false }, // Example for 3rd axis
                    legend: {x: 0.1, y: 1.1, orientation: "h"},
                    paper_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', plot_bgcolor: isDarkMode ? '#2d3748' : '#f9fafb', font: { color: isDarkMode ? '#e2e8f0' : '#374151' }, margin: { t:40, l:50, r:50, b:40 }
                }, {responsive: true});


            } catch (err) {
                console.error("Error rendering analytics charts:", err);
                // Show error message in chart divs
            }
            updatePersonalizedFeedback();
        }

        function updatePersonalizedFeedback() {
            if (experimentHistory.length < 3) {
                personalizedFeedbackPanelEl.classList.add('hidden');
                return;
            }
            // Simple feedback example
            const avgEfficiency = experimentHistory.reduce((sum, e) => sum + e.results.efficiency_percent, 0) / experimentHistory.length;
            personalizedFeedbackTextEl.textContent = `Based on your ${experimentHistory.length} experiments, the average transmission efficiency is ${avgEfficiency.toFixed(2)}%. Keep experimenting to see how different parameters affect this!`;
            personalizedFeedbackPanelEl.classList.remove('hidden');
        }

        // --- Comparison View ---
        let selectedForComparison = [];

        function handleCompareCheckboxChange(event) {
            const experimentId = parseInt(event.target.dataset.experimentId);
            if (event.target.checked) {
                if (selectedForComparison.length < MAX_COMPARISON_ITEMS) {
                    selectedForComparison.push(experimentId);
                } else {
                    event.target.checked = false; // Prevent checking more than max
                    showCustomAlert(`You can select a maximum of ${MAX_COMPARISON_ITEMS} experiments for comparison.`);
                }
            } else {
                selectedForComparison = selectedForComparison.filter(id => id !== experimentId);
            }
            renderComparisonView();
        }

        function updateComparisonAvailability() {
             if (selectedForComparison.length >= 1 && selectedForComparison.length <= MAX_COMPARISON_ITEMS) { // Show if at least 1 selected
                noComparisonMsgEl.classList.add('hidden');
            } else {
                noComparisonMsgEl.classList.remove('hidden');
                comparisonContainerEl.innerHTML = ''; // Clear if no valid selection
            }
        }

        function renderComparisonView() {
            comparisonContainerEl.innerHTML = '';
             updateComparisonAvailability();
            if (selectedForComparison.length === 0) return;

            selectedForComparison.forEach(id => {
                const entry = experimentHistory.find(e => e.id === id);
                if (!entry) return;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600';
                const loadInfoComp = entry.params.loadType === 'power' ? `${entry.params.loadPower_MW_3ph.toFixed(1)}MW, ${entry.params.loadPF.toFixed(2)}PF ${entry.params.loadPFType}` : `${entry.params.loadZ_mag.toFixed(1)}Ω ∠${entry.params.loadZ_angle_deg.toFixed(1)}°`;

                itemDiv.innerHTML = `
                    <h4 class="text-md font-semibold text-blue-600 mb-2">ID: ${entry.id} (${entry.params.lineModel})</h4>
                    <p class="text-xs text-gray-500 mb-1">${entry.timestamp}</p>
                    <p class="text-sm"><strong>Length:</strong> ${entry.params.lineLength} km</p>
                    <p class="text-sm"><strong>Load:</strong> ${loadInfoComp}</p>
                    <hr class="my-2 dark:border-gray-600">
                    <p class="text-sm"><strong>|A|:</strong> ${entry.results.A_mag.toFixed(4)}</p>
                    <p class="text-sm"><strong>|B|:</strong> ${entry.results.B_mag.toFixed(2)} Ω</p>
                    <p class="text-sm"><strong>|C|:</strong> ${(entry.results.C_mag * 1000).toFixed(4)} mS</p>
                    <p class="text-sm"><strong>|D|:</strong> ${entry.results.D_mag.toFixed(4)}</p>
                    <hr class="my-2 dark:border-gray-600">
                    <p class="text-sm"><strong>VR:</strong> ${entry.results.voltageRegulation_percent.toFixed(2)}%</p>
                    <p class="text-sm"><strong>Eff:</strong> ${entry.results.efficiency_percent.toFixed(2)}%</p>
                    <p class="text-sm mt-1"><strong>Note:</strong> ${entry.note}</p>
                `;
                comparisonContainerEl.appendChild(itemDiv);
            });
        }

        // --- Event Listeners Setup ---
        // Step navigation
        document.getElementById('start-sim-btn').addEventListener('click', () => goToStep(2));
        document.getElementById('params-to-review-btn').addEventListener('click', () => {
            const params = getSimulationParameters();
            if (params) { displayReviewData(params); goToStep(3); }
        });
        document.getElementById('review-to-params-btn').addEventListener('click', () => goToStep(2));
        document.getElementById('review-to-theory-btn').addEventListener('click', () => {
            const params = getSimulationParameters(); // Need model for theory
            if (params) { displayTheory(params.lineModel); goToStep(4); }
        });
        document.getElementById('theory-to-review-btn').addEventListener('click', () => goToStep(3));
        document.getElementById('theory-to-load-btn').addEventListener('click', () => goToStep(5));
        document.getElementById('load-to-theory-btn').addEventListener('click', () => goToStep(4));
        document.getElementById('load-to-usercalc-btn').addEventListener('click', async () => {
            const simData = getSimulationParameters();
            if (!simData) return;
            // Pre-calculate actual results for user checking, but don't display them yet
            const results = await runSimulation();
            if (results) {
                clearUserCalcFeedback(); // Clear previous feedback and inputs
                goToStep(6);
            }
        });
        document.getElementById('usercalc-to-load-btn').addEventListener('click', () => goToStep(5));
        document.getElementById('check-user-calc-btn').addEventListener('click', checkUserCalculations);
        document.getElementById('usercalc-to-results-btn').addEventListener('click', () => {
            if (currentSimulationResults && currentSimulationResults.A) { // Check if results are ready
                displayResults(currentSimulationResults);
                goToStep(7);
            } else {
                showCustomAlert("Please run or complete the simulation steps before viewing results.");
            }
        });
        document.getElementById('results-to-usercalc-btn').addEventListener('click', () => goToStep(6));
        document.getElementById('results-to-analysis-btn').addEventListener('click', () => goToStep(8));
        document.getElementById('analysis-to-params-btn').addEventListener('click', () => goToStep(2));
        document.getElementById('reset-simulation-flow-btn').addEventListener('click', () => {
            showCustomConfirm("Reset simulation? All current inputs will be cleared.", () => {
                loadDefaultParameters();
                currentSimulationData = {};
                currentSimulationResults = {};
                clearUserCalcFeedback();
                goToStep(1);
                speakMessage("Simulation reset.");
            });
        });
        
        // Other buttons
        document.getElementById('load-defaults-params-btn').addEventListener('click', loadDefaultParameters);
        document.getElementById('save-results-btn').addEventListener('click', () => {
            if (currentSimulationResults && currentSimulationResults.A) {
                addExperimentToHistory(currentSimulationResults);
            } else {
                showCustomAlert("No results to save. Please run a simulation first.");
            }
        });
        document.getElementById('saveCurrentConfigWithNoteBtn').addEventListener('click', () => {
             if (currentSimulationResults && currentSimulationResults.A) { // Save if results are available
                addExperimentToHistory(currentSimulationResults, historyNoteInputEl.value.trim());
            } else if (Object.keys(currentSimulationData).length > 0 && currentSimulationData.lineModel) { // Save if only params are set
                 // Create a dummy result structure if only params are available
                const dummyResults = { A: new Complex(0,0), B: new Complex(0,0), C: new Complex(0,0), D: new Complex(0,0), Vs_mag_LL_kV:0, voltageRegulation_percent:0, efficiency_percent:0 };
                addExperimentToHistory({ ...currentSimulationData, ...dummyResults }, historyNoteInputEl.value.trim());
                showCustomAlert("Current parameters saved. Run simulation for full results.");
            } else {
                showCustomAlert("No current configuration or results to save. Please configure parameters or run a simulation.");
            }
        });
        
        // Modal close buttons
        document.getElementById('alert-ok-btn').addEventListener('click', () => alertModal.classList.add('hidden'));
        document.getElementById('confirm-no-btn').addEventListener('click', () => confirmModal.classList.add('hidden'));
        document.getElementById('show-full-theory-modal-btn').addEventListener('click', () => {
            theoryModal.classList.remove('hidden');
            speakMessage("Detailed theory modal opened.");
        });
        document.getElementById('theory-modal-close-btn').addEventListener('click', () => theoryModal.classList.add('hidden'));

        // Dark mode
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        darkModeToggle.addEventListener('change', () => {
            isDarkMode = darkModeToggle.checked;
            document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('abcdSimDarkMode', isDarkMode);
            // Re-render charts with new theme if they exist
            if (currentStep === 7 && currentSimulationResults.A) renderPhasorDiagram(currentSimulationResults);
            if (document.getElementById('analyticsTab').classList.contains('active')) renderAnalyticsCharts();
            speakMessage(isDarkMode ? "Dark mode enabled." : "Dark mode disabled.");
        });

        // Voice toggle
        document.getElementById('voice-toggle-btn').addEventListener('click', toggleVoiceInstructions);
        
        // Print and Screenshot
        document.getElementById('print-btn').addEventListener('click', () => window.print());
        document.getElementById('screenshot-btn').addEventListener('click', () => {
            const activeTabPanel = document.querySelector('.tab-panel.active') || document.body;
            showLoadingOverlay();
            html2canvas(activeTabPanel, { scale: 1.5, useCORS: true, backgroundColor: isDarkMode ? '#1a202c' : '#f3f4f6' })
                .then(canvas => {
                    const link = document.createElement('a');
                    link.download = `abcd_simulator_screenshot_${new Date().toISOString().slice(0,10)}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    hideLoadingOverlay();
                    speakMessage("Screenshot captured.");
                }).catch(err => {
                    console.error("Screenshot failed:", err);
                    showCustomAlert("Could not take screenshot.");
                    hideLoadingOverlay();
                });
        });


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load dark mode preference
            if (localStorage.getItem('abcdSimDarkMode') === 'true') {
                darkModeToggle.checked = true;
                isDarkMode = true;
                document.documentElement.classList.add('dark');
            }
            // Load voice preference
            if (localStorage.getItem('abcdSimVoiceEnabled') === 'true') {
                isVoiceEnabled = true;
                 document.getElementById('voice-on-icon').classList.remove('hidden');
                 document.getElementById('voice-off-icon').classList.add('hidden');
            } else {
                isVoiceEnabled = false;
                document.getElementById('voice-on-icon').classList.add('hidden');
                document.getElementById('voice-off-icon').classList.remove('hidden');
            }

            loadDefaultParameters();
            updateStepUI();
            loadHistory();
            toggleLoadInputFields(); // Ensure correct load inputs are shown initially
        });

    </script>
</body>
</html>

